# Получение данных через `Logs API` и загрузка в `ClickHouse`

## Logs API

`Logs API` позволяет выгрузить сырые данные со счетчика.

Документация по `Logs API` - https://yandex.ru/dev/metrika/doc/api2/logs/intro.html

Данные для этого кейса также доступны на Яндекс.Диске - https://disk.yandex.ru/d/sUmQmh_MnQWL4g?w=1

### Шаг 1: получаем токен
Для работы с API необходимо получить свой токен - https://yandex.ru/dev/oauth/doc/dg/tasks/get-oauth-token.html

Создаем приложение тут (указываем права для чтения в Яндекс.Метрике) - https://oauth.yandex.ru/client/new

Переходим по ссылке вида - `https://oauth.yandex.ru/authorize?response_type=token&client_id=<идентификатор приложения>`

Полученный токен можно сохранить в домашнюю директорию в файл `.yatoken.txt`

### Что делать Если не получилось вытянуть данные через `LogsAPI` ?
* Данные можно скачать по ссылке. https://disk.yandex.ru/d/sUmQmh_MnQWL4g?w=1
* Положить их с текущую директорию.
* Потом раскомментировать нижние две строчки
* Проинтерпретировать их и двиунться дальше

## ClickHouse
### Подключение и настройка
https://cloud.yandex.ru/docs/managed-clickhouse/
(см. слайды)

### Данные для доступа
* Из интерфейса облака в разделе хосты копируем имя хост в переменную `CH_HOST` вида `'https://{ИМЯ_ХОСТА}.mdb.yandexcloud.net:8443'`
* Используем заведенного юзера в переменной `CH_USER`
* Сохраним пароль заведенного пользователя в текстовый файл `.chpass.txt`
* В переменную `CH_PASS` считаем содержимое файла `.chpass.txt`
* В переменную `cacert` поместим путь к сертификату для подключения к серверу. Файл `YandexInternalRootCA.crt` должен лежать в репозитории

### Проверяем ClickHouse
Используя заговленные выше переменные проверим доступ до сервера (как в документации https://cloud.yandex.ru/docs/managed-clickhouse/operations/connect#connection-string)

При успешном подключении не произойдет никакой ошибки при выполнении кода ниже, а в `rs.text` будет содержаться версия сервера ClickHouse (например `20.8.12.2`)

###  Функции для интеграции с ClickHouse

В файле `some_funcs` есть класс `simple_ch_client` c 3 функциями
* get_clickhouse_data
* get_clickhouse_df
* upload

Сначала надо создать экземпляр класса, инициализировав его начальными параметрами - хост, пользователь, пароль и путь к сертификату
